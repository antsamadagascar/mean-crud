# Configuration D√©ploiement Application MEAN en Production

## üìã Vue d'ensemble

Ce guide d√©taille le d√©ploiement d'une application MEAN (MongoDB, Express, Angular, Node.js) sur MongoDB Atlas et Render.

---

## 1Ô∏è‚É£ Configuration MongoDB Atlas (Base de donn√©es)

### 1.1 Cr√©ation du compte
- Acc√©dez √† : https://cloud.mongodb.com/
- Cr√©ez un compte gratuit

### 1.2 Cr√©ation du projet
- Cr√©ez un nouveau projet MongoDB

### 1.3 Configuration du Cluster (gratuit)

**A. Configuration de la connexion**
- Cr√©ez un utilisateur de base de donn√©es
  - Username : `votre_username`
  - Password : `votre_password` (notez-le pr√©cieusement)

**B. Configuration des drivers**
- Driver : Node.js
- Version : 5.5 or later

**C. Configuration de l'acc√®s IP**
- Ajoutez l'adresse IP : `0.0.0.0/0` (autorise toutes les IP - n√©cessaire pour Render)
- Status : Attendez que le statut passe de "Pending" √† "Active"

**D. R√©cup√©ration de l'URI de connexion**
- Format : `mongodb+srv://<username>:<password>@cluster0.xxxxx.mongodb.net/<nom_base>?retryWrites=true&w=majority`
- Remplacez `<username>` et `<password>` par vos identifiants
- Ajoutez le nom de votre base de donn√©es (ex: `/mean_db`)

---

## 2Ô∏è‚É£ Configuration Render (H√©bergement)

### 2.1 Cr√©ation du compte
- Acc√©dez √† : https://dashboard.render.com/
- Cr√©ez un compte et liez votre compte GitHub/GitLab

---

## 3Ô∏è‚É£ D√©ploiement Backend (Express + Node.js)

### 3.1 Cr√©ation du Web Service

**A. Configuration initiale**
- Type de service : **Web Service**
- Connexion au d√©p√¥t Git : S√©lectionnez votre repository backend

**B. Configuration Build & Deploy**
- **Root Directory** : `backend` (si votre backend est dans un sous-dossier)
- **Build Command** : `npm install`
- **Start Command** : `node server.js` (ou `npm start`)

**C. Variables d'environnement (Section Environment)**

Ajoutez ces variables (Key: Value) :

| Key | Value | Description |
|-----|-------|-------------|
| `MONGO_URI` | `mongodb+srv://username:password@cluster0.xxxxx.mongodb.net/mean_db?retryWrites=true&w=majority` | URI MongoDB Atlas |
| `NODE_ENV` | `production` | Environnement de production |
| `PORT` | `3000` | Port du serveur |
| `FRONTEND_URL` | `https://votre-frontend.onrender.com` | URL du frontend (√† mettre √† jour apr√®s d√©ploiement frontend) |

**D. D√©ploiement**
- Render d√©ploie automatiquement
- V√©rifiez les logs : statut "Deploy successful" ‚úÖ ou "Deploy failed" ‚ùå
- Notez l'URL g√©n√©r√©e : `https://votre-backend-xxxxx.onrender.com`

---

## 4Ô∏è‚É£ D√©ploiement Frontend (Angular)

### 4.1 Configuration locale du projet Angular

**A. V√©rifiez `angular.json`**

Dans la section `projects > frontend > architect > build > configurations > production`, assurez-vous d'avoir :
```json
"production": {
  "fileReplacements": [
    {
      "replace": "src/environments/environment.ts",
      "with": "src/environments/environment.prod.ts"
    }
  ],
  "optimization": true,
  "outputHashing": "all",
  "sourceMap": false,
  "namedChunks": false,
  "extractLicenses": true
}
```

**B. Configurez `src/environments/environment.prod.ts`**
```typescript
export const environment = {
  production: true,
  apiUrl: 'https://votre-backend-xxxxx.onrender.com/api'
};
```

‚ö†Ô∏è Remplacez par l'URL r√©elle de votre backend Render

**C. Configurez le fichier `_redirects` pour le routing SPA**

1. Cr√©ez le dossier `public/` s'il n'existe pas :
```bash
mkdir -p public
```

2. Cr√©ez le fichier `public/_redirects` :
```
/*    /index.html   200
```

3. Modifiez `angular.json` pour copier ce fichier :
```json
"assets": [
  "src/favicon.ico",
  "src/assets",
  {
    "glob": "_redirects",
    "input": "public",
    "output": "/"
  }
]
```

**D. Build de production en local (test)**
```bash
cd frontend
ng build --configuration production
```

V√©rifiez que :
- Le build compile sans erreur ‚úÖ
- Le fichier `_redirects` est dans `dist/frontend/browser/` ‚úÖ
- Aucune r√©f√©rence √† `localhost` dans les fichiers JS :
```bash
grep -r "localhost" dist/
```

**E. Pushez sur Git**
```bash
git add .
git commit -m "Configuration production: environment et redirects"
git push origin main
```

### 4.2 Cr√©ation du Static Site sur Render

**A. Configuration initiale**
- Type de service : **Static Site**
- Connexion au d√©p√¥t Git : S√©lectionnez votre repository frontend

**B. Configuration Build & Deploy**
- **Root Directory** : `frontend` (si votre frontend est dans un sous-dossier)
- **Build Command** : `npm run build`
- **Publish Directory** : `dist/frontend/browser` (ou `dist/frontend` selon votre version Angular)

**C. Configuration Redirects/Rewrites (IMPORTANT)**

Dans le Dashboard Render, allez dans : **Settings ‚Üí Redirects/Rewrites**

Ajoutez cette r√®gle :

| Field | Value |
|-------|-------|
| **Source** | `/*` |
| **Destination** | `/index.html` |
| **Action** | `Rewrite` |

Cette configuration permet √† Angular Router de g√©rer toutes les routes.

**D. D√©ploiement**
- Render d√©ploie automatiquement
- V√©rifiez les logs : statut "Deploy successful" ‚úÖ
- Notez l'URL g√©n√©r√©e : `https://votre-frontend.onrender.com`

### 4.3 Mise √† jour de la variable FRONTEND_URL du backend

Retournez dans votre **Web Service backend** ‚Üí **Environment** et mettez √† jour :
```
FRONTEND_URL=https://votre-frontend.onrender.com
```

Sauvegardez. Le backend red√©marrera automatiquement.

---

## 5Ô∏è‚É£ V√©rification du d√©ploiement

### 5.1 Test du Backend
```bash
# Test de la route sant√©
curl https://votre-backend.onrender.com/health

# R√©ponse attendue :
{
  "status": "OK",
  "mongodb": "connected",
  "timestamp": "..."
}

# Test de l'API
curl https://votre-backend.onrender.com/api/articles
```

### 5.2 Test du Frontend

1. Acc√©dez √† : `https://votre-frontend.onrender.com`
2. Ouvrez la console du navigateur (F12)
3. V√©rifiez :
   - Aucune erreur JavaScript ‚úÖ
   - Les requ√™tes HTTP vont vers `votre-backend.onrender.com/api` ‚úÖ
   - Pas d'erreurs CORS ‚úÖ

4. Testez le routing :
   - `https://votre-frontend.onrender.com/` ‚Üí Fonctionne ‚úÖ
   - `https://votre-frontend.onrender.com/articles` ‚Üí Fonctionne ‚úÖ

---

## 6Ô∏è‚É£ Workflow de mise √† jour

Pour d√©ployer de nouvelles modifications :
```bash
# 1. D√©veloppez en local
# 2. Testez avec ng serve (frontend) et npm start (backend)
# 3. Committez vos changements
git add .
git commit -m "Description des changements"
git push origin main

# 4. Render d√©tecte automatiquement et red√©ploie
# 5. V√©rifiez les logs de d√©ploiement sur Render Dashboard
```

---

## 7Ô∏è‚É£ Points de s√©curit√© importants

### ‚úÖ √Ä FAIRE
- Fichier `.env` ajout√© au `.gitignore` (ne JAMAIS pusher les secrets)
- Variables sensibles configur√©es dans Render Environment (pas dans le code)
- CORS configur√© pour autoriser uniquement l'URL du frontend
- MongoDB Atlas avec authentification activ√©e

### ‚ùå √Ä NE PAS FAIRE
- Ne JAMAIS pusher le fichier `.env` sur Git
- Ne JAMAIS hardcoder les mots de passe dans le code
- Ne pas utiliser `0.0.0.0/0` pour MongoDB en production r√©elle (sauf pour Render qui a des IP dynamiques)

---

## üìã Checklist finale de d√©ploiement

**MongoDB Atlas :**
- [ ] Cluster cr√©√© et actif
- [ ] Utilisateur de BDD cr√©√©
- [ ] IP `0.0.0.0/0` autoris√©e
- [ ] URI de connexion r√©cup√©r√©e

**Backend (Render Web Service) :**
- [ ] Repository Git connect√©
- [ ] Build et Start commands configur√©es
- [ ] Variables d'environnement ajout√©es (MONGO_URI, NODE_ENV, PORT, FRONTEND_URL)
- [ ] D√©ploiement r√©ussi
- [ ] API accessible et fonctionnelle

**Frontend (Render Static Site) :**
- [ ] `environment.prod.ts` configur√© avec URL backend
- [ ] Fichier `_redirects` cr√©√© et copi√© dans le build
- [ ] Build command et Publish directory configur√©s
- [ ] Redirects/Rewrites configur√© (`/* ‚Üí /index.html`)
- [ ] D√©ploiement r√©ussi
- [ ] Application accessible et routing fonctionnel

**Tests :**
- [ ] Backend r√©pond sur `/health` et `/api/articles`
- [ ] Frontend charge sans erreur
- [ ] Pas d'erreurs CORS
- [ ] Communication frontend ‚Üî backend fonctionnelle
- [ ] MongoDB stocke et r√©cup√®re les donn√©es

---

## üÜò R√©solution des probl√®mes courants

| Probl√®me | Cause probable | Solution |
|----------|---------------|----------|
| 404 sur routes Angular | Redirects/Rewrites non configur√© | Ajouter `/* ‚Üí /index.html` dans Render |
| Erreur CORS | CORS mal configur√© backend | V√©rifier `FRONTEND_URL` et configuration CORS |
| Connexion MongoDB √©choue | IP non autoris√©e | V√©rifier IP Access List : `0.0.0.0/0` |
| Backend appelle localhost | Mauvais environment | V√©rifier `environment.prod.ts` avec bonne URL |
| Build failed | Erreurs de syntaxe | V√©rifier logs Render, corriger le code |

---

**Date de cr√©ation :** 23 Janvier 2026  
**Stack :** MongoDB Atlas + Express.js + Angular 19 + Node.js sur Render

                                                 By RATOVONANDRASANA Aina Ny Antsa